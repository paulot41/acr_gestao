{% extends 'core/dashboard_base.html' %}
{% load static %}

{% block stats_cards %}
<div class="col-md-3">
    <div class="card text-center h-100">
        <div class="card-body">
            <div class="stat-icon text-primary mb-2">
                <i class="fas fa-calendar-day"></i>
            </div>
            <h3 class="fw-bold">{{ stats.todays_classes }}</h3>
            <p class="text-muted mb-0">Aulas Hoje</p>
        </div>
    </div>
</div>
<div class="col-md-3">
    <div class="card text-center h-100">
        <div class="card-body">
            <div class="stat-icon text-info mb-2">
                <i class="fas fa-calendar-week"></i>
            </div>
            <h3 class="fw-bold">{{ stats.weekly_classes }}</h3>
            <p class="text-muted mb-0">Próximos 7 Dias</p>
        </div>
    </div>
</div>
<div class="col-md-3">
    <div class="card text-center h-100">
        <div class="card-body">
            <div class="stat-icon text-success mb-2">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h3 class="fw-bold">{{ stats.monthly_classes }}</h3>
            <p class="text-muted mb-0">Este Mês</p>
        </div>
    </div>
</div>
<div class="col-md-3">
    <div class="card text-center h-100">
        <div class="card-body">
            <div class="stat-icon text-warning mb-2">
                <i class="fas fa-users"></i>
            </div>
            <h3 class="fw-bold">{{ stats.total_students_today }}</h3>
            <p class="text-muted mb-0">Alunos Hoje</p>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_content %}
<div class="col-lg-8">
    <!-- Aulas de Hoje -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-calendar-day me-2"></i>Aulas de Hoje
            </h5>
            <span class="badge bg-primary">{{ todays_classes|length }} aula{{ todays_classes|length|pluralize:"s" }}</span>
        </div>
        <div class="card-body">
            {% if todays_classes %}
                {% for event in todays_classes %}
                <div class="upcoming-event p-3 rounded mb-3">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">{{ event.title }}</h6>
                            <p class="text-muted mb-1">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ event.resource.name }}
                                {% if event.modality %}
                                    • <i class="fas fa-tag me-1"></i>{{ event.modality.name }}
                                {% endif %}
                            </p>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                {{ event.starts_at|date:"H:i" }} - {{ event.ends_at|date:"H:i" }}
                                ({{ event.starts_at|timeuntil }})
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="mb-2">
                                <span class="badge bg-info">
                                    {{ event.bookings_count }}/{{ event.capacity }} inscritos
                                </span>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'core:event_edit' event.id %}" class="btn btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-outline-info" onclick="viewClassDetails({{ event.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    {% if event.bookings.all %}
                    <div class="mt-3 pt-2 border-top">
                        <small class="text-muted">Participantes:</small>
                        <div class="mt-1">
                            {% for booking in event.bookings.all %}
                                {% if booking.status == 'confirmed' %}
                                    <span class="badge bg-light text-dark me-1">{{ booking.person.full_name }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Não tem aulas hoje</h5>
                    <p class="text-muted">Desfrute do seu dia livre!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Próximas Aulas -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-calendar-week me-2"></i>Próximas Aulas (7 dias)
            </h5>
        </div>
        <div class="card-body">
            {% if upcoming_classes %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Aula</th>
                                <th>Local</th>
                                <th>Participantes</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in upcoming_classes %}
                            <tr>
                                <td>
                                    <strong>{{ event.starts_at|date:"d/m" }}</strong><br>
                                    <small>{{ event.starts_at|date:"H:i" }} - {{ event.ends_at|date:"H:i" }}</small>
                                </td>
                                <td>
                                    <strong>{{ event.title }}</strong>
                                    {% if event.modality %}
                                        <br><small class="text-muted">{{ event.modality.name }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ event.resource.name }}</td>
                                <td>
                                    <span class="badge bg-{% if event.is_full %}warning{% else %}info{% endif %}">
                                        {{ event.bookings_count }}/{{ event.capacity }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'core:event_edit' event.id %}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-outline-info btn-sm" onclick="viewClassDetails({{ event.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted text-center py-3">Não tem aulas marcadas para os próximos 7 dias</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="col-lg-4">
    <!-- Perfil do Instrutor -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-user-circle me-2"></i>Meu Perfil
            </h5>
        </div>
        <div class="card-body text-center">
            {% if instructor.photo %}
                <img src="{{ instructor.photo.url }}" alt="{{ instructor.full_name }}" class="rounded-circle mb-3" width="80" height="80">
            {% else %}
                <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-user fa-2x text-white"></i>
                </div>
            {% endif %}

            <h5 class="mb-1">{{ instructor.full_name }}</h5>
            <p class="text-muted mb-2">{{ instructor.get_entity_affiliation_display }}</p>

            {% if instructor.specialties %}
                <div class="mt-3">
                    <small class="text-muted">Especialidades:</small>
                    <p class="small">{{ instructor.specialties }}</p>
                </div>
            {% endif %}

            <div class="row text-center mt-3">
                <div class="col-6">
                    <small class="text-muted">Comissão ACR</small><br>
                    <strong>{{ instructor.acr_commission_rate }}%</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted">Comissão Proform</small><br>
                    <strong>{{ instructor.proform_commission_rate }}%</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações Rápidas -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-bolt me-2"></i>Ações Rápidas
            </h5>
        </div>
        <div class="card-body">
            <div class="d-grid gap-2">
                <a href="{% url 'core:event_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Nova Aula
                </a>
                <a href="{% url 'core:gantt_view' %}" class="btn btn-outline-info">
                    <i class="fas fa-calendar me-2"></i>Ver Horários
                </a>
                <a href="{% url 'core:instructor_detail' instructor.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-edit me-2"></i>Editar Perfil
                </a>
            </div>
        </div>
    </div>

    <!-- Dicas do Sistema -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-lightbulb me-2"></i>Dicas
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info py-2 mb-2">
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    Use o sistema Gantt para uma visão completa dos horários
                </small>
            </div>
            <div class="alert alert-success py-2 mb-2">
                <small>
                    <i class="fas fa-check-circle me-1"></i>
                    Mantenha o seu perfil atualizado para melhor comunicação
                </small>
            </div>
            <div class="alert alert-warning py-2 mb-0">
                <small>
                    <i class="fas fa-exclamation-circle me-1"></i>
                    Verifique os participantes antes do início de cada aula
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
function viewClassDetails(eventId) {
    // Implementar modal com detalhes da aula
    fetch(`/api/events/${eventId}/details/`)
        .then(response => response.json())
        .then(data => {
            // Mostrar modal com detalhes
            $('#quickActionModal .modal-title').text('Detalhes da Aula');
            $('#quickActionModal .modal-body').html(`
                <h6>${data.title}</h6>
                <p><strong>Local:</strong> ${data.resource}</p>
                <p><strong>Horário:</strong> ${data.start_time} - ${data.end_time}</p>
                <p><strong>Participantes:</strong> ${data.bookings_count}/${data.capacity}</p>
                <hr>
                <h6>Lista de Participantes:</h6>
                <ul class="list-unstyled">
                    ${data.participants.map(p => `<li><i class="fas fa-user me-2"></i>${p.name}</li>`).join('')}
                </ul>
            `);
            $('#quickActionModal').modal('show');
        })
        .catch(error => {
            console.error('Erro ao carregar detalhes:', error);
            alert('Erro ao carregar detalhes da aula');
        });
}

// Auto-refresh das aulas de hoje a cada 2 minutos
setInterval(function() {
    // Implementar se necessário
}, 120000);
</script>
{% endblock %}
